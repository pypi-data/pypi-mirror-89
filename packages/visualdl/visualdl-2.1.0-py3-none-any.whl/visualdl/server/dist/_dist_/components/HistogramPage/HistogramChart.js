function X(n,r){var i=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);r&&(o=o.filter(function(g){return Object.getOwnPropertyDescriptor(n,g).enumerable})),i.push.apply(i,o)}return i}function Z(n){for(var r=1;r<arguments.length;r++){var i=arguments[r]!=null?arguments[r]:{};r%2?X(Object(i),!0).forEach(function(o){et(n,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):X(Object(i)).forEach(function(o){Object.defineProperty(n,o,Object.getOwnPropertyDescriptor(i,o))})}return n}function et(n,r,i){return r in n?Object.defineProperty(n,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[r]=i,n}import ot from"../LineChart.js";import{Modes as a,options as rt}from"../../resource/histogram/index.js";import f,{useCallback as z,useEffect as nt,useMemo as c,useRef as it,useState as F}from"../../../web_modules/react.js";import st from"../StackChart.js";import{rem as I,size as L}from"../../utils/style.js";import lt from"../ChartToolbox.js";import{distance as at}from"../../utils/index.js";import mt from"../../utils/event.js";import{fetcher as ct}from"../../utils/fetch.js";import{format as M}from"../../../web_modules/d3-format.js";import ut from"../../../web_modules/lodash/minBy.js";import ft from"../../../web_modules/query-string.js";import d from"../../../web_modules/styled-components.js";import{useRunningRequest as dt}from"../../hooks/useRequest.js";import pt from"../../hooks/useThrottleFn.js";import{useTranslation as vt}from"../../../web_modules/react-i18next.js";import gt from"../../hooks/useWebAssembly.js";const W=M(".4f"),Y=M(".4"),ht=d.div.withConfig({displayName:"HistogramChart__Wrapper",componentId:"sc-1nqqqkz-0"})([""," display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;"],L("100%","100%")),yt=d(ot).withConfig({displayName:"HistogramChart__StyledLineChart",componentId:"sc-1nqqqkz-1"})(["flex-grow:1;"]),xt=d(st).withConfig({displayName:"HistogramChart__StyledStackChart",componentId:"sc-1nqqqkz-2"})(["flex-grow:1;"]),bt=d(lt).withConfig({displayName:"HistogramChart__Toolbox",componentId:"sc-1nqqqkz-3"})(["margin-left:",";margin-right:",";margin-bottom:",";"],I(20),I(20),I(18)),Ot=d.div.withConfig({displayName:"HistogramChart__Error",componentId:"sc-1nqqqkz-4"})([""," display:flex;justify-content:center;align-items:center;"],L("100%","100%")),jt=({cid:n,run:r,tag:i,mode:o,running:g})=>{const{t:u}=vt(["histogram","common"]),h=it(null),{data:p,error:$,loading:y}=dt(`/histogram/list?${ft.stringify({run:r.label,tag:i})}`,!!g,ct,{refreshInterval:60*1e3}),[P,V]=F(!1),B=z(()=>{mt.emit("toggle-chart-size",n,!P),V(e=>!e)},[n,P]),x=c(()=>`${i} (${r.label})`,[i,r.label]),K=c(()=>[p!=null?p:[],o],[p,o]),{data:s}=gt("histogram_transform",K),[m,b]=F(null);nt(()=>b(null),[o]);const O=c(()=>{if(o===a.Overlay)return s==null?void 0:s.data.map((t,l)=>({name:`${u("common:time-mode.step")}${t[0][1]}`,data:t,lineStyle:{color:r.colors[l===m||m==null?0:1]},z:l===m?s==null?void 0:s.data.length:l,encode:{x:[2],y:[3]}}));if(o===a.Offset){var e;const t=s;return{minX:t==null?void 0:t.minX,maxX:t==null?void 0:t.maxX,minY:t==null?void 0:t.minStep,maxY:t==null?void 0:t.maxStep,minZ:t==null?void 0:t.minZ,maxZ:t==null?void 0:t.maxZ,data:(e=t==null?void 0:t.data)!==null&&e!==void 0?e:[]}}return null},[s,o,r,m,u]),k=c(()=>({[a.Overlay]:e=>{var t;if(!s||m==null)return"";const l=e.find(v=>v.data[1]===s.data[m][0][1]);return(t=l==null?void 0:l.seriesName)!==null&&t!==void 0?t:""},[a.Offset]:e=>e[2]}),[m,s]),T=c(()=>({[a.Overlay]:e=>e.axisDimension==="x"?W(e.value):e.axisDimension==="y"?Y(e.value):"",[a.Offset]:(e,t)=>e.axisDimension==="x"?W(t==null?void 0:t[0]):e.axisDimension==="y"?Y(t==null?void 0:t[1]):""}),[]),j=c(()=>Z(Z({},rt[o]),{},{color:[r.colors[0]],tooltip:{formatter:k[o]},axisPointer:{label:{formatter:T[o]}},xAxis:{axisPointer:{snap:o===a.Overlay}},yAxis:{axisPointer:{snap:o===a.Overlay}}}),[o,r,k,T]),G=z((e,{offsetX:t,offsetY:l})=>{const v=e.getOption().series,Q=[t,l];if(v){var C;const U=v.map((_,N)=>{var S;return(S=_.data)===null||S===void 0?void 0:S.reduce((D,[,,H,A])=>{const tt=e.convertToPixel("grid",[H,A]),R=at(tt,Q);return R<D[2]?[H,A,R,N]:D},[0,0,Number.POSITIVE_INFINITY,N])}),q=ut(U,_=>_[2]);b((C=q==null?void 0:q[3])!==null&&C!==void 0?C:null);return}},[]),w=pt(G,{wait:200}),E=z(e=>{const t=e.getZr();t&&(t.on("mousemove",l=>w.run(e,l)),t.on("mouseout",()=>{w.cancel(),b(null)}))},[w]),J=c(()=>o===a.Overlay?f.createElement(yt,{ref:h,title:x,data:O,options:j,loading:y,onInit:E}):o===a.Offset?f.createElement(xt,{ref:h,title:x,data:O,options:j,loading:y}):null,[O,y,o,j,x,E]);return!s&&$?f.createElement(Ot,null,u("common:error")):f.createElement(ht,null,J,f.createElement(bt,{items:[{icon:"maximize",activeIcon:"minimize",tooltip:u("histogram:maximize"),activeTooltip:u("histogram:minimize"),toggle:!0,onClick:B},{icon:"download",tooltip:u("histogram:download-image"),onClick:()=>{var e;return(e=h.current)===null||e===void 0?void 0:e.saveAsImage()}}]}))};export default jt;
