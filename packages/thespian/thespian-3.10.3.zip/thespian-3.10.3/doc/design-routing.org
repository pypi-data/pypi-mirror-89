* Routing Messages

Under normal circumstances, messages are sent directly to the target
address (route D below).  However, there are times when messages
should be relayed through the Admin (e.g. if only the Admin has an
open external port connection).

#+BEGIN_SRC ditaa :file routes.png

   /-----------------------------\   /---------------------\
   |                             |   |                     |
   |         +-->-----------------------------------+      |
   |         |                   |   |              |      |
   |    +----+----+              |   |  +--------+  |      |
   |    | Admin1  +->-------------------+ Admin2 |  |      |
   |    |         |    B         |   |  |        |  |      |
   |    |         |          +----->----+        |  |A     |
   |    +----+----+         C|   |   |  +------+-+  |      |
   |         |               |   |   |         |    |      |
   |         |        +------+-+ |   |     B,C v    |      |
   |         +------<-+ Actor2 | |   |         |    |      |
   |          A,B     |        +--->---+       |    |      |
   |                  +----+---+ |   | |     +-+----+-+    |
   |    +---------+        :     |   | +-----+ Actor3 |    |
   |    | Actor1  +-<------+     |   |    D  |        |    |
   |    |         |              |   |       +--------+    |
   |    +---------+              |   |                     |
   |                             |   |                     |
   \-----------------------------/   \---------------------/

#+END_SRC

In the figure above, there are 4 routes from Actor2 to Actor3:

   1. A :: Actor2 must send to the local Admin, which sends directly
           to the remote Actor3.
   2. B :: Actor2 must send to the local Admin, which then forwards to
           the remote Admin, which sends to Actor3.
   3. C :: Actor2 must send to the remote Admin, which then forwards
           to Actor3.
   4. D :: Actor2 sends directly to Actor3.

The normal Actor communications path is 4, but the other paths may be
used if there are routing constraints.  For all configurations, Actor1
and Actor2 should be able to communicate directly.

If the remote system (Admin2) can only respond on a specific port,
then Admin2 should be bound to that port and route B or C utilized.

If the remote system (Admin2) cannot accept inbound connections, then
route B must be used so that Admin1 can queue messages waiting for
transmit to Admin2/Actor3.

Route A is not practically needed: any configuration where route A
would be used it should be possible to simply use either D or B.

** Addresses

Addresses are obtained by an Actor from the following sources:

   * ~createActor()~ results
   * sender identification on ~receiveMessage()~
   * passed inside of a message

** Admin Routing

  In the system managed by Admin2, the "Admin Routing" capability
  should be set to True to indicate that Actor3 cannot be targeted by
  external addresses.

  When generating the Address for Actor3, it will have a "routing"
  element of Admin; this causes sends to that address to check if the
  sender's Admin is the same address as the routing element.  If so,
  the message can be sent directly (supporting the Actor1/Actor2
  communications path), otherwise the sender must wrap the message in
  a ForwardMessage and send the ForwardMessage to the routing address
  (Admin).

  This enables path C.

** Unidirectional Connectivity

  If either of Admin1 or Admin2 cannot accept inbound connections and
  can only make outbound connections, then path B should be used (at
  least for sending to the system that can only make outbound
  connections).

  For example, if Admin1 can only make outbound connections, then
  Admin2 should be pre-registered.  Path D can be used for data from
  Actor2 to Actor3, but path B must be used for data from Actor3 to
  Actor2.

  If outbound-only is enabled, "Admin Routing" is enabled by default.
  When generating an Address in a system that is outbound-only, the
  address will have a "routing" element of (None, Admin).  This
  indicates to remote senders that they should send the packet to
  their local Admin first (the None portion) and their Admin should
  forward to the Admin in the routing element for delivery.  If the
  sending and receiving actor are both in the same system, the
  sender's Admin will match the Admin in the routing packet and the
  direct Actor-to-Actor send can be performed instead.

  This enables path B.

** Convention Management

*** Scenario 1

Normal connectivity, remote system knows what Convention Leader's
address is and initiates connectivity.  Remote system also
periodically sends updates to the leader to confirm its continued
membership in the convention.

No convention messages indicate pre-registration.

TBD: where is first field used? 

    | Sequence | Notifyee    | Leader                                  | Remote                            |
    |----------+-------------+-----------------------------------------+-----------------------------------|
    | S1A      |             |                                         | <-- ConvReg                       |
    |          |             | add rmt                                 |                                   |
    | normal   |             | ConvReg (ack) -->                       |                                   |
    | mode     | ConvAdd <-- |                                         | upd leader info                   |
    |          |             |                                         | :                                 |
    |          |             |                                         | <-- ConvReg                       |
    |          |             | refresh rmt                             |                                   |
    |          |             | ConvReg (ack) -->                       |                                   |
    |          |             |                                         | upd leader info                   |
    |----------+-------------+-----------------------------------------+-----------------------------------|
    | S1B      |             |                                         | <-- ConvReg                       |
    |          |             |                                         | :                                 |
    | never    |             |                                         | <-- ConvReg                       |
    | joins    |             |                                         | :                                 |
    |          |             |                                         | S1A                               |
    |----------+-------------+-----------------------------------------+-----------------------------------|
    | S1C      |             |                                         | S1A                               |
    |          |             |                                         | :                                 |
    | loses    |             |                                         | <-- ConvReg                       |
    | leader   |             |                                         | :                                 |
    |          |             |                                         | <-- ConvReg                       |
    |          |             |                                         | :                                 |
    |          |             |                                         | [too many retries with no answer] |
    |          |             |                                         | upd no leader connection          |
    |          |             |                                         | :                                 |
    |          |             |                                         | <-- ConvReg * N                   |
    |          |             |                                         | :                                 |
    |          |             |                                         | S1A/S1B                           |
    |----------+-------------+-----------------------------------------+-----------------------------------|
    | S1D      |             | S1A                                     |                                   |
    |          |             | :                                       |                                   |
    | leader   |             | [too much time, no ConvReg from remote] |                                   |
    | loses    | ConvRmv <-- | remove remote                           |                                   |
    | member   |             | :                                       |                                   |
    |          |             |                                         | <-- ConvReg                       |
    |          |             | S1A                                     |                                   |
    |----------+-------------+-----------------------------------------+-----------------------------------|
    | S1E      |             | S1A                                     |                                   |
    |          |             | :                                       |                                   |
    | active   |             |                                         | <-- ConvDeReg                     |
    | member   | ConvRmv <-- | remove remote                           |                                   |
    | member   |             | :                                       |                                   |
    | exit     |             |                                         | <-- ConvReg                       |
    |          |             | S1A                                     |                                   |
    |----------+-------------+-----------------------------------------+-----------------------------------|
    | S1F      |             | S1A                                     |                                   |
    |          |             | :                                       |                                   |
    | active   |             | ConvDeReg -->                           |                                   |
    | leader   | ConvRmv <-- |                                         | :                                 |
    | exit     |             |                                         | <-- ConvReg                       |
    |          |             | S1A                                     |                                   |
    |----------+-------------+-----------------------------------------+-----------------------------------|


*** Scenario 2

TXOnly connectivity from the admin, remote does not know the
Convention Leader's address.  Remote system also periodically sends
updates to the leader to confirm its continued membership in the
convention.

  | Sequence       | External or Notifyee  | Leader                              | Remote                            |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2A  normal    | ConvReg(prereg) -->   | add rmt / prereg-only               |                                   |
  |                |                       | HysteresisCancel                    |                                   |
  | .1 ->          |                       | ConvInvite -->                      |                                   |
  |                |                       |                                     | add/update leader                 |
  | .2 ->          |                       |                                     | <-- ConvReg                       |
  |                | ConvAdd <--           | refresh rmt                         |                                   |
  |                |                       | ConvReg(ack) -->                    |                                   |
  |                |                       |                                     | :                                 |
  |                |                       |                                     | <-- ConvReg                       |
  |                |                       | refresh rmt                         |                                   |
  |                |                       | ConvReg (ack) -->                   |                                   |
  |                |                       |                                     | upd leader info                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2B            | ConvReg(prereg) -->   | add rmt / prereg-only               |                                   |
  |                |                       | HysteresisCancel                    |                                   |
  |                |                       | ConvInvite -->                      |                                   |
  | never joins    |                       | :                                   |                                   |
  |                |                       | ConvInvite -->                      |                                   |
  |                |                       | :                                   |                                   |
  |                |                       | *                                   |                                   |
  |                |                       | :                                   |                                   |
  |                |                       | [S2A.1 if eventually joins]         |                                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2C            | S2A                   |                                     |                                   |
  |                |                       |                                     | :                                 |
  | loses leader   |                       |                                     | <-- ConvReg                       |
  |                |                       |                                     | :                                 |
  |                |                       |                                     | <-- ConvReg                       |
  |                |                       |                                     | :                                 |
  |                |                       |                                     | [too many retries with no answer] |
  |                |                       |                                     | upd no leader connection because  |
  |                |                       |                                     | originally joined via invite      |
  |                |                       |                                     | --idle--                          |
  |                |                       | :                                   |                                   |
  |                |                       | ConvReg (ack) -->                   | ignored                           |
  |                |                       | :                                   |                                   |
  |                |                       | S2A                                 |                                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2D            | S2A                   |                                     |                                   |
  |                |                       | :                                   |                                   |
  | leader         |                       | [no checkins in extended period]    |                                   |
  | loses member   | ConvRmv <--           | note as not member but still prereg |                                   |
  |                |                       | :                                   |                                   |
  |                |                       | ConvInvite -->                      |                                   |
  |                |                       | :                                   |                                   |
  |                |                       | *                                   |                                   |
  |                |                       | :                                   |                                   |
  |                |                       | S2A.1                               |                                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2E            | S2A                   |                                     |                                   |
  |                | :                     |                                     |                                   |
  | active member  |                       |                                     | <-- ConvDeReg                     |
  | exit           | ConvRmv <--           | note as not member but still prereg |                                   |
  |                |                       | :                                   |                                   |
  |                |                       | ConvInvite -->                      |                                   |
  |                |                       | :                                   |                                   |
  |                |                       | *                                   |                                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2F            |                       | S2E                                 |                                   |
  | active member  |                       | :                                   |                                   |
  | restart        |                       | S2A.1                               |                                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2G            | S2A                   |                                     |                                   |
  |                |                       | :                                   |                                   |
  | active leader  | ConvDeReg(prereg) --> |                                     |                                   |
  | exit           |                       | ConvDeReg -->                       |                                   |
  |                | ConvRmv <--           |                                     | upd no leader connection          |
  |                |                       | not member, not prereg              | --idle--                          |
  |                | :                     |                                     |                                   |
  |                | S2A                   |                                     |                                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|
  | S2H            |                       | S2D                                 | S2C                               |
  |                |                       |                                     |                                   |
  | leader->member |                       |                                     |                                   |
  | socket closed  |                       |                                     |                                   |
  |----------------+-----------------------+-------------------------------------+-----------------------------------|


Assert: leader knows about remote
Assert: remote knows about leader
Assert: only messages needed for registration, no excessive communications


* TBD / Future

** Buffer system

  Would be nice to use two actor systems on the same node, the primary
  with outside connectivity and non-root, the secondary with root and
  internally connected only.

  One actor system runs on address 127.0.0.1 only?

  Internal-only system specifies outbound-only, but need to have
  additional hops?

  This needs additional convention interaction as well, since
  currently only first degree conventions are supported.
