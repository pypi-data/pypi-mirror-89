function G(e,r){var l=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);r&&(i=i.filter(function(w){return Object.getOwnPropertyDescriptor(e,w).enumerable})),l.push.apply(l,i)}return l}function U(e){for(var r=1;r<arguments.length;r++){var l=arguments[r]!=null?arguments[r]:{};r%2?G(Object(l),!0).forEach(function(i){te(e,i,l[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(l)):G(Object(l)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(l,i))})}return e}function te(e,r,l){return r in e?Object.defineProperty(e,r,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[r]=l,e}import a,{useCallback as W,useEffect as k,useMemo as j,useRef as C,useState as P}from"../../../web_modules/react.js";import{ellipsis as K,em as x,primaryColor as re,rem as p,size as ne,transitionProps as M}from"../../utils/style.js";import oe from"../ChartToolbox.js";import le from"../../../web_modules/react-spinners/GridLoader.js";import ie from"./StepSlider.js";import{fetcher as se}from"../../utils/fetch.js";import{formatTime as ae}from"../../utils/index.js";import V from"../../../web_modules/lodash/isEmpty.js";import ce from"../../../web_modules/mime-types.js";import B from"../../../web_modules/query-string.js";import{saveFile as me}from"../../utils/saveFile.js";import E from"../../../web_modules/styled-components.js";import ue from"../../hooks/useRequest.js";import{useRunningRequest as de}from"../../hooks/useRequest.js";import{useTranslation as fe}from"../../../web_modules/react-i18next.js";const pe=E.div.withConfig({displayName:"SampleChart__Wrapper",componentId:"sc-19m7v01-0"})(["height:100%;padding:",";padding-bottom:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;> *{flex-grow:0;flex-shrink:0;}"],x(20)),we=E.div.withConfig({displayName:"SampleChart__Title",componentId:"sc-19m7v01-1"})(["display:flex;justify-content:space-between;align-items:center;margin-bottom:",";> h4{font-size:",";font-weight:700;flex-shrink:1;flex-grow:1;padding:0;margin:0;","}> span{font-size:",";flex-shrink:0;flex-grow:0;color:var(--text-light-color);"," max-width:50%;"," &::before{content:'';display:inline-block;"," margin-right:",";border-radius:",";vertical-align:middle;background-color:",";}}"],x(20),x(16),K(),x(14),K(),M("color"),ne(p(5),p(17)),p(8),p(2.5),e=>e.color),ge=E.div.withConfig({displayName:"SampleChart__Container",componentId:"sc-19m7v01-2"})(["flex-grow:1;flex-shrink:1;margin:"," 0;display:flex;justify-content:center;align-items:center;overflow:hidden;cursor:",";"],x(20),e=>e.preview?"zoom-in":"default"),he=E.div.withConfig({displayName:"SampleChart__Footer",componentId:"sc-19m7v01-3"})(["margin-bottom:",";display:flex;align-items:center;justify-content:space-between;"],p(18)),ye=E.div.withConfig({displayName:"SampleChart__FooterInfo",componentId:"sc-19m7v01-4"})(["color:var(--text-lighter-color);font-size:",";"," > *{display:inline-block;margin-left:",";}"],p(12),M("color"),p(10)),ve=(e,r,l,i,w)=>`/${e}/${e}?${B.stringify({index:r,ts:w,run:l,tag:i})}`,be=({run:e,tag:r,running:l,type:i,cache:w,footer:H,content:T,previewer:O})=>{const{t:g,i18n:J}=fe(["sample","common"]),{data:o,error:R,loading:I}=de(`/${i}/list?${B.stringify({run:e.label,tag:r})}`,!!l),u=j(()=>{var t;return(t=o==null?void 0:o.map(s=>s.step))!==null&&t!==void 0?t:[]},[o]),[S,D]=P(!1),[n,_]=P(0),[h,q]=P(),c=C({}),v=C(null),N=C(null);k(()=>{const t=s=>{const ee=document.querySelectorAll(":hover");(S||Array.from(ee).some(m=>m.isSameNode(N.current)))&&(s.key==="ArrowLeft"||s.key==="ArrowUp"?(_(m=>m>0?m-1:m),s.preventDefault()):(s.key==="ArrowRight"||s.key==="ArrowDown")&&(_(m=>m<u.length-1?m+1:m),s.preventDefault()))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[u,S]),k(()=>{Object.values(c.current).forEach(({timer:t})=>window.clearTimeout(t)),c.current={}},[r,e]);const b=j(()=>{var t;return(t=o==null?void 0:o[n].wallTime)!==null&&t!==void 0?t:0},[o,n]),y=W(()=>{if(!o)return;const t=ve(i,n,e.label,r,b);c.current[n]={src:t,timer:window.setTimeout(()=>{(s=>delete c.current[s])(n)},w)},q(t),v.current=null},[i,n,e.label,r,b,o,w]);k(()=>{if(c.current[n])q(c.current[n].src);else if(V(c.current))y();else return v.current=window.setTimeout(y,500),()=>{v.current!=null&&(window.clearTimeout(v.current),v.current=null)}},[n,y]);const[z,Q]=P(!1),$=C(null),A=C(new IntersectionObserver(t=>{if(t[0].intersectionRatio>0){var s;Q(!0),(s=A.current)===null||s===void 0||s.disconnect()}}));k(()=>{const t=A.current;if($.current&&t)return t.observe($.current),()=>t.disconnect()},[]);const{data:d,error:F,loading:L}=ue(h!=null?h:null,se,{dedupingInterval:5*60*1e3}),X=W(()=>{if(d){const t=d.type?ce.extension(d.type):null;me(d.data,`${e.label}-${r}-${u[n]}-${b}`+(t?`.${t}`:""))}},[d,e.label,r,u,n,b]),f=j(()=>{if(h)return{data:d,error:F,loading:L}},[h,d,F,L]),Y=j(()=>I||!c.current[n]||!z?a.createElement(le,{color:re,size:"10px"}):!o&&R?a.createElement("span",null,g("common:error")):V(o)?a.createElement("span",null,g("common:empty")):f?T(f):null,[z,I,R,o,n,f,g,T]),Z=j(()=>O&&(S&&f)?O(U(U({},f),{},{loading:!c.current[n]||f.loading,steps:u,step:n,onClose:()=>D(!1),onChange:_,onChangeComplete:y})):null,[O,f,S,u,n,y]);return a.createElement(pe,{ref:N},a.createElement(we,{color:e.colors[0]},a.createElement("h4",null,r),a.createElement("span",null,e.label)),a.createElement(ie,{value:n,steps:u,onChange:_,onChangeComplete:y},ae(b,J.language)),a.createElement(ge,{ref:$,preview:!!O&&!!h,onClick:()=>D(!0)},Y),Z,a.createElement(he,null,a.createElement(oe,{items:[{icon:"download",tooltip:g(`sample:download-${i}`),onClick:X}]}),a.createElement(ye,null,a.createElement("span",null,g("sample:sample"),g("common:colon"),o!=null&&o.length?`${n+1}/${o.length}`:"--/--"),H)))};export default be;
