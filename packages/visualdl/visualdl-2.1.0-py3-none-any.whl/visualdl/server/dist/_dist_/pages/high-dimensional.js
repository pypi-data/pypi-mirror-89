const ge={};import Ve from"../../__snowpack__/env.js";ge.env=Ve;function me(o,i){var l=Object.keys(o);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(o);i&&(s=s.filter(function(g){return Object.getOwnPropertyDescriptor(o,g).enumerable})),l.push.apply(l,s)}return l}function q(o){for(var i=1;i<arguments.length;i++){var l=arguments[i]!=null?arguments[i]:{};i%2?me(Object(l),!0).forEach(function(s){Ue(o,s,l[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(l)):me(Object(l)).forEach(function(s){Object.defineProperty(o,s,Object.getOwnPropertyDescriptor(l,s))})}return o}function Ue(o,i,l){return i in o?Object.defineProperty(o,i,{value:l,enumerable:!0,configurable:!0,writable:!0}):o[i]=l,o}import We,{AsideSection as O}from"../components/Aside.js";import qe from"../components/HighDimensionalPage/HighDimensionalChart.js";import Ke from"../components/HighDimensionalPage/LabelSearchInput.js";import t,{useCallback as b,useEffect as h,useMemo as d,useRef as Xe,useState as a}from"../../web_modules/react.js";import ze from"../components/Select.js";import Ye from"../components/BodyLoading.js";import Ge from"../components/Button.js";import Je from"../components/Content.js";import Qe from"../components/HighDimensionalPage/DimensionSwitch.js";import Ze from"../components/Error.js";import p from"../components/Field.js";import et from"../components/HighDimensionalPage/LabelSearchResult.js";import tt from"../components/HighDimensionalPage/PCADetail.js";import nt from"../components/HighDimensionalPage/ReductionTab.js";import ot from"../components/HighDimensionalPage/TSNEDetail.js";import at from"../components/Title.js";import it from"../components/HighDimensionalPage/UMAPDetail.js";import lt from"../components/HighDimensionalPage/UploadDialog.js";import ue from"../../web_modules/query-string.js";import{rem as K}from"../utils/style.js";import _ from"../../web_modules/styled-components.js";import{toast as X}from"../../web_modules/react-toastify.js";import z from"../hooks/useRequest.js";import{useTranslation as rt}from"../../web_modules/react-i18next.js";import st from"../hooks/useWorker.js";const ct=ge.env.MODE,dt={pca:5e4,tsne:1e4,umap:5e3},mt={pca:200,tsne:void 0,umap:void 0},ut=_.div.withConfig({displayName:"high-dimensional__AsideTitle",componentId:"kunowy-0"})(["font-size:",";line-height:",";font-weight:700;margin-bottom:",";"],K(16),K(16),K(20)),he=_(ze).withConfig({displayName:"high-dimensional__FullWidthSelect",componentId:"kunowy-1"})(["width:100%;"]),ht=_(Ge).withConfig({displayName:"high-dimensional__FullWidthButton",componentId:"kunowy-2"})(["width:100%;"]),pe=_(We).withConfig({displayName:"high-dimensional__HDAside",componentId:"kunowy-3"})([".secondary{color:var(--text-light-color);}"]),pt=_(pe).withConfig({displayName:"high-dimensional__RightAside",componentId:"kunowy-4"})(["border-left:1px solid var(--border-color);"]),gt=_(pe).withConfig({displayName:"high-dimensional__LeftAside",componentId:"kunowy-5"})(["border-right:1px solid var(--border-color);","{border-bottom:none;}> .aside-top > .search-result{margin-top:0;margin-left:0;margin-right:0;flex:auto;overflow:hidden auto;}"],O),ft=_(Je).withConfig({displayName:"high-dimensional__HDContent",componentId:"kunowy-6"})(["background-color:var(--background-color);"]),vt=()=>{const{t:o}=rt(["high-dimensional","common"]),i=Xe(null),{data:l,loading:s}=z("/embedding/list"),g=d(()=>{var e;return(e=l==null?void 0:l.map(n=>q({value:n.name,label:n.name},n)))!==null&&e!==void 0?e:[]},[l]),[u,Y]=a(),E=d(()=>g.find(e=>e.value===u),[g,u]);h(()=>{var e,n;Y((e=(n=g[0])===null||n===void 0?void 0:n.value)!==null&&e!==void 0?e:void 0)},[g]);const{data:I,loading:G}=z(u?`/embedding/tensor?${ue.stringify({name:u})}`:null),{data:N,loading:J}=z(u?`/embedding/metadata?${ue.stringify({name:u})}`:null),[fe,Q]=a(!1),[H,y]=a(!1),[F,w]=a("");h(()=>{H||w("")},[H]),h(()=>{F&&y(!0)},[F]),h(()=>{G&&(y(!0),w("fetching-tensor"))},[G]),h(()=>{J&&(y(!0),w("fetching-metadata"))},[J]);const[S,Z]=a(null),[ee,te]=a(null),ve=b(e=>{Z(e),te(null)},[]),[M,be]=a(""),[ne,Ee]=a(""),[ye,_e]=a(new Float32Array),[D,we]=a([]),[A,oe]=a(),[ae,De]=a([]),[x,Ce]=a(0),[Pe,je]=a([0,0]),L=b(e=>{if(e!=null){const n=D.indexOf(e);if(n!==-1)return ae.map(c=>c[n])}return[]},[D,ae]),Se=d(()=>L(A),[L,A]),[C,Re]=a("3d"),[f,Oe]=a("pca"),Ne=d(()=>C==="3d",[C]),T=b((e,n,c)=>{if(n){y(!0),w(e);const r=new FileReader;r.readAsText(n,"utf-8"),r.onload=()=>{c(R=>{const j=r.result;return R===j&&y(!1),j})}}else c("")},[]);h(()=>T("reading-vector",S,be),[S,T]),h(()=>T("reading-metadata",ee,Ee),[ee,T]),h(()=>Z(null),[u]);const B=b(e=>{X(e.message,{position:X.POSITION.TOP_CENTER,type:X.TYPE.ERROR}),ct!=="production"&&console.error(e),y(!1)},[]),Ae=d(()=>{const e={maxCount:dt[f],maxDimension:mt[f]};return M?{from:"string",params:q({vectors:M,metadata:ne},e)}:E&&I?{from:"blob",params:q({shape:E.shape,vectors:I.data,metadata:N!=null?N:""},e)}:null},[f,M,E,I,ne,N]),ie=st("high-dimensional/parse-data",Ae);h(()=>{const{error:e,data:n}=ie;e?B(e):n?(je(n.rawShape),Ce(n.dimension),_e(n.vectors),we(n.labels),oe(n.labels[0]),De(n.metadata)):n!==null&&w("parsing")},[ie,B]);const le=d(()=>x!==0,[x]),k=d(()=>{var e;return S?S.name:(e=E==null?void 0:E.path)!==null&&e!==void 0?e:""},[S,E]),[$,Le]=a(5),[V,Te]=a(10),[U,Ie]=a(15),re=b(e=>{var n;Ie(e),(n=i.current)===null||n===void 0||n.rerunUMAP()},[]),[m,se]=a(),He=b(()=>{se(void 0),w("calculating")},[]),Fe=b(e=>{se(e),y(!1)},[]),[v,Me]=a({labelBy:void 0,value:""}),P=d(()=>{if(v.labelBy==null||v.value==="")return{indices:[],metadata:[]};const e=L(v.labelBy),n=[],c=[];for(let r=0;r<e.length;r++)e[r].includes(v.value)&&(n.push(e[r]),c.push(r));return{indices:c,metadata:n}},[L,v.labelBy,v.value]),[xe,Be]=a([]),ce=b(e=>Be(e==null?[]:[P.indices[e]]),[P.indices]),de=d(()=>{var e,n,c,r,R,j,W;switch(f){case"pca":return t.createElement(tt,{dimension:C,variance:(e=m==null?void 0:m.variance)!==null&&e!==void 0?e:[],totalVariance:(n=m==null?void 0:m.totalVariance)!==null&&n!==void 0?n:0});case"tsne":return t.createElement(ot,{iteration:(c=m==null?void 0:m.step)!==null&&c!==void 0?c:0,perplexity:$,learningRate:V,onChangePerplexity:Le,onChangeLearningRate:Te,onPause:(r=i.current)===null||r===void 0?void 0:r.pauseTSNE,onResume:(R=i.current)===null||R===void 0?void 0:R.resumeTSNE,onStop:(j=i.current)===null||j===void 0?void 0:j.pauseTSNE,onRerun:(W=i.current)===null||W===void 0?void 0:W.rerunTSNE});case"umap":return t.createElement(it,{neighbors:U,onRun:re});default:return null}},[f,C,m,$,V,U,re]),ke=d(()=>t.createElement(pt,null,t.createElement(O,null,t.createElement(ut,null,o("high-dimensional:data")),t.createElement(p,{label:o("high-dimensional:select-data")},t.createElement(he,{list:g,value:u,onChange:Y})),t.createElement(p,{label:o("high-dimensional:select-label")},t.createElement(he,{list:D,value:A,onChange:oe})),t.createElement(p,null,t.createElement(ht,{rounded:!0,outline:!0,type:"primary",onClick:()=>Q(!0)},o("high-dimensional:upload-data"))),t.createElement(p,null,k&&t.createElement("div",{className:"secondary"},o("high-dimensional:data-path"),o("common:colon"),k))),t.createElement(O,null,t.createElement(p,null,t.createElement(nt,{value:f,onChange:Oe})),t.createElement(p,{label:o("high-dimensional:dimension")},t.createElement(Qe,{value:C,onChange:Re})),de)),[o,k,f,C,D,A,g,u,de]),$e=d(()=>t.createElement(gt,null,t.createElement(O,null,t.createElement(p,null,t.createElement(Ke,{labels:D,onChange:Me})),v.value!==""&&t.createElement(p,{className:"secondary"},t.createElement("span",null,o("high-dimensional:matched-result-count",{count:P.metadata.length})))),t.createElement(O,{className:"search-result"},t.createElement(p,null,t.createElement(et,{list:P.metadata,onHovered:ce})))),[ce,D,v.value,P.metadata,o]);return t.createElement(t.Fragment,null,t.createElement(at,null,o("common:high-dimensional")),H||s?t.createElement(Ye,null,o(`high-dimensional:loading.${F}`)):null,t.createElement(ft,{aside:ke,leftAside:$e},le?t.createElement(qe,{ref:i,vectors:ye,labels:Se,shape:Pe,dim:x,is3D:Ne,reduction:f,perplexity:$,learningRate:V,neighbors:U,focusedIndices:xe,highlightIndices:P.indices,onCalculate:He,onCalculated:Fe,onError:B}):t.createElement(Ze,null),t.createElement(lt,{open:fe,hasVector:le,onClose:()=>Q(!1),onChangeVectorFile:ve,onChangeMetadataFile:te})))};export default vt;
