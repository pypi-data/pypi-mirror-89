import*as o from"../web_modules/react.js";import*as l from"../web_modules/react-dom.js";import $ from"../web_modules/htm.js";import*as i from"../web_modules/fast-json-patch.js";import y from"./event-to-object.js";const c=$.bind(o.createElement),g={};export function mountLayoutWithWebSocket(n,t){if(t.startsWith(".")||t.startsWith("/")){let a=window.location,u;a.protocol==="https:"?u="wss:":u="ws:";let f=u+"//"+a.host;t.startsWith(".")&&(new_url+=a.pathname+"/"),t=f+t}const e=new WebSocket(t);function s(a){e.onmessage=u=>{const[f,b]=JSON.parse(u.data);a(f,b)}}function r(a){e.send(JSON.stringify({header:{},body:{event:a}}))}return mountLayout(n,s,r)}export function mountLayout(n,t,e){l.render(c`<${p} saveUpdateHook=${t} sendEvent=${e} />`,n)}export default function p({saveUpdateHook:n,sendEvent:t}){const[e,s]=k({});return o.useEffect(()=>n(s),[s]),e.tagName?c`<${h} sendEvent=${t} model=${e} />`:c`<div />`}function h({sendEvent:n,model:t}){if(t.importSource)return c`<${w} sendEvent=${n} model=${t} />`;{const e=m(n,t),s=d(n,t);return t.children&&t.children.length?c`<${t.tagName} ...${s}>${e}<//>`:c`<${t.tagName} ...${s} />`}}function w({sendEvent:n,model:t}){const e=j(t.importSource.source);if(e){const s=E(e,t.tagName),r=m(n,t),a=d(n,t);return c`<${s} ...${a}>${r}<//>`}else return c`<div>${t.importSource.fallback}<//>`}function m(n,t){return t.children?t.children.map(e=>{switch(typeof e){case"object":return c`<${h} model=${e} sendEvent=${n} />`;case"string":return e}}):[]}function d(n,t){const e=Object.assign({},t.attributes);return t.eventHandlers&&Object.keys(t.eventHandlers).forEach(s=>{const r=t.eventHandlers[s];e[s]=P(n,r)}),e}function P(n,t){return function(){const e=Array.from(arguments).map(r=>typeof r=="object"&&r.nativeEvent?(t.preventDefault&&r.preventDefault(),t.stopPropagation&&r.stopPropagation(),y(r)):r),s=new Promise((r,a)=>{const u={data:e,target:t.target};n(u),r(u)})}}function j(n){const[t,e]=o.useState(g[n]);return t||v(n).then(e),t}function v(n){return import(n).then(t=>t.default?t.default:t,t=>{if(t.stack)return console.log(t),{default:function(){return c`
              <pre>
                  <h1>Error</h1>
                  <code>${[t.stack,t.message]}</code>
                </pre
              >
            `}};throw t})}function E(n,t){const e=t.split("."),s=e.shift();let r=n[s];for(let a=0;a<e.length;a++)r=r[e[a]];return r}function k(n){const t=o.useRef(n),e=H(),s=o.useCallback((r,a)=>{S(t.current,r,a),e()},[t,e]);return[t.current,s]}function S(n,t,e){t?i.applyPatch(n,[{op:"replace",path:t,value:i.applyPatch(i.getValueByPointer(n,t),e,!1,!1).newDocument}]):i.applyPatch(n,e)}function H(){const[,n]=o.useState();return o.useCallback(()=>n({}),[])}
