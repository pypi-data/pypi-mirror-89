{% extends '_layout.html' %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="/static/styles/annotator.css">
{% endblock %}

{% block content %}
    {% if document is not none %}
        <div class="columns">
            <div class="column">
                <a href="/projects/{{ project.id }}" class="button is-pulled-left"><i
                        class="fas fa-tasks mr-1"></i><span>Project</span></a>
                <a id="nextButton" href="javascript:void(0)" class="button is-primary is-pulled-right"
                   onclick="submit(null)">
                    <span>Next</span><i class="fas fa-arrow-circle-right pl-1"></i></a>
            </div>
        </div>
        {% if project.render_header(document) is not none %}
            <div class="columns">
                <div class="column">
                    <div class="box">
                        {{ project.render_header(document) | safe }}
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="columns">
            <div class="column">
                <div class="box">
                    {% if project.type == 'sequence_labeling' %}
                        <div class="annotator-div is-family-primary is-size-4" id="annotationField"></div>
                    {% elif project.type == 'document_classification' %}
                        <p class="card-text flex-grow-1">{{ document.text }}</p>
                        {% for ll in project.labels %}
                            <label class="form-check-label">{{ ll.label }}</label>
                            <input class="form-check-input" type="checkbox"
                                   value={{ ll.value }} id="option_{{ ll.value }}"
                                   onchange="submit(getLabel('{{ ll.value }}'))"
                                   {% if annotation_set is not none and annotation_set.get_annotation(ll.value) is not none %}checked{% endif %}>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="columns">
            <div class="column">
                <div class="box has-text-centered">
                    <h1 class="title">Congratulations!</h1>
                    <h2 class="subtitle">You have completed annotating all documents in this project.</h2>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/annotator.js"></script>
    <!--suppress JSUnresolvedFunction, JSUnresolvedVariable -->
    {% if document is not none %}
        <script>
            function getLabel(id) {
                let checkbox = $('#option_' + id);
                return {value: checkbox.val(), status: checkbox.prop('checked')};
            }

            function showLoading() {
                let nextButton = document.getElementById('nextButton');
                nextButton.classList.add('is-loading');
            }

            function submit(data, type = 'label', method = 'POST') {
                showLoading();
                let temp = {};
                let target = '/projects/{{ project.id }}/annotate';
                if (data !== null) {
                    temp = {data, type};
                    target = '/projects/{{ project.id }}/annotate/' + '{{ document.id | safe }}';
                }
                $.ajax({
                    type: method,
                    url: '/projects/{{ project.id }}/annotate/' + '{{ document.id | safe }}',
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(temp),
                    success: function (data) {
                        window.location.href = target;
                    },
                });
            }

            {% if project.type == 'sequence_labeling' %}
                function initialize(annotations) {
                    let a = new Annotator('annotationField', '{{ document.text | safe }}', JSON.parse('{{ options | safe }}'));
                    // load initial annotations
                    a.setAnnotations(annotations);
                    // listen to events - delete
                    a.addEventListener('delete', (annotation) => {
                        submit(annotation, 'annotation', 'DELETE');
                    });
                    // listen to events - update
                    a.addEventListener('update', (annotation, value) => {
                        annotation.label = value;
                        submit(annotation, 'annotation');
                    });
                    // initialize annotator
                    a.initialize();
                }

                $(document).ready(function () {
                    let annotations = JSON.parse('{{ annotations | safe }}');
                    initialize(annotations)
                });
            {% endif %}
        </script>
    {% endif %}
{% endblock %}