function N(n,t){var o=Object.keys(n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(n);t&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),o.push.apply(o,s)}return o}function m(n){for(var t=1;t<arguments.length;t++){var o=arguments[t]!=null?arguments[t]:{};t%2?N(Object(o),!0).forEach(function(s){me(n,s,o[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(o)):N(Object(o)).forEach(function(s){Object.defineProperty(n,s,Object.getOwnPropertyDescriptor(o,s))})}return n}function me(n,t,o){return t in n?Object.defineProperty(n,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[t]=o,n}import de,{XAxisType as u,YAxisType as b}from"../LineChart.js";import f,{useCallback as h,useMemo as c,useRef as pe,useState as Y}from"../../../web_modules/react.js";import{XAxis as ue,chartData as fe,options as X,nearestPoint as ge,singlePointRange as K,sortingMethodMap as ye,tooltip as be,xAxisMap as U}from"../../resource/scalar/index.js";import{rem as _,size as B}from"../../utils/style.js";import he from"../ChartToolbox.js";import ve from"../TooltipTable.js";import{cycleFetcher as je}from"../../utils/fetch.js";import xe from"../../utils/event.js";import{format as we}from"../../../web_modules/d3-format.js";import G from"../../../web_modules/query-string.js";import{renderToStaticMarkup as _e}from"../../../web_modules/react-dom/server.js";import Ce from"../../utils/saveFile.js";import v from"../../../web_modules/styled-components.js";import{useRunningRequest as Oe}from"../../hooks/useRequest.js";import{useTranslation as Te}from"../../../web_modules/react-i18next.js";import C from"../../hooks/useWebAssembly.js";const H={csv:"csv",tsv:"tsv"},Pe=we(".8"),Se=v.div.withConfig({displayName:"ScalarChart__Wrapper",componentId:"sc-1caty5y-0"})([""," display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;"],B("100%","100%")),ze=v(de).withConfig({displayName:"ScalarChart__StyledLineChart",componentId:"sc-1caty5y-1"})(["flex-grow:1;"]),De=v(he).withConfig({displayName:"ScalarChart__Toolbox",componentId:"sc-1caty5y-2"})(["margin-left:",";margin-right:",";margin-bottom:",";"],_(20),_(20),_(18)),Re=v.div.withConfig({displayName:"ScalarChart__Error",componentId:"sc-1caty5y-3"})([""," display:flex;justify-content:center;align-items:center;"],B("100%","100%")),Ee=({cid:n,runs:t,tag:o,smoothing:s,xAxis:i,sortingMethod:O,outlier:T,smoothedOnly:P,showMostValue:S,running:J})=>{const{t:l,i18n:z}=Te(["scalar","common"]),j=pe(null),{data:g,error:Q,loading:Z}=Oe(t.map(e=>`/scalar/list?${G.stringify({run:e.label,tag:o})}`),!!J,(...e)=>je(e)),[D,V]=Y(!1),R=h(()=>{xe.emit("toggle-chart-size",n,!D),V(e=>!e)},[n,D]),p=c(()=>i===ue.WallTime?u.time:u.value,[i]),[E,$]=Y(b.value),k=h(()=>{$(e=>e===b.log?b.value:b.log)},[$]),ee=c(()=>{var e;return[(e=g==null?void 0:g.map(r=>r!=null?r:[]))!==null&&e!==void 0?e:[],s]},[g,s]),{data:y}=C("scalar_transform",ee),a=c(()=>y!=null?y:[],[y]),te=c(()=>[a,!!T],[a,T]),{data:A}=C("scalar_axis_range",te),oe=c(()=>[a],[a]),{data:d}=C("scalar_range",oe),x=c(()=>{let e,r=A;return a.length===1&&a[0].length===1&&([u.value,u.log].includes(p)&&(e=K(a[0][0][U[i]])),r=K(a[0][0][2])),{x:e,y:r}},[a,A,p,i]),M=c(()=>fe({data:a.slice(0,t.length),ranges:S?d!=null?d:[]:[],runs:t,xAxis:i,smoothedOnly:P}),[a,d,t,i,P,S]),I=c(()=>String(Math.max(...a.map(e=>Math.max(...e.map(r=>r[1]))))).length,[a]),L=h(e=>{const r=Array.isArray(e)?e[0].data:e.data,q=U[i],ne=ge(a!=null?a:[],t,q,r[q]).map((w,ce)=>m(m({},w),d==null?void 0:d[ce])),se=ye[O],F=se(ne,r),{columns:le,data:ie}=be(F,I,z);return _e(f.createElement(ve,{run:l("common:runs"),runs:F.map(w=>w.run),columns:le,data:ie}))},[a,d,t,O,i,I,l,z]),ae=c(()=>m(m({},X),{},{tooltip:m(m({},X.tooltip),{},{formatter:L,hideDelay:300,enterable:!0}),xAxis:m(m({type:p},x.x),{},{axisPointer:{label:{formatter:p===u.time?void 0:({value:e})=>Pe(e)}}}),yAxis:m({type:E},x.y)}),[L,x,p,E]),W=h(e=>{Ce(t.map(r=>`/scalar/data?${G.stringify({run:r.label,tag:o,type:e})}`),t.map(r=>`visualdl-scalar-${r.label}-${o}.${H[e]}`),`visualdl-scalar-${o}.zip`)},[t,o]),re=c(()=>[{icon:"maximize",activeIcon:"minimize",tooltip:l("scalar:maximize"),activeTooltip:l("scalar:minimize"),toggle:!0,onClick:R},{icon:"restore-size",tooltip:l("scalar:restore"),onClick:()=>{var e;return(e=j.current)===null||e===void 0?void 0:e.restore()}},{icon:"log-axis",tooltip:l("scalar:toggle-log-axis"),toggle:!0,onClick:k},{icon:"download",menuList:[{label:l("scalar:download-image"),onClick:()=>{var e;return(e=j.current)===null||e===void 0?void 0:e.saveAsImage()}},{label:l("scalar:download-data"),children:Object.keys(H).sort((e,r)=>e.localeCompare(r)).map(e=>({label:l("scalar:download-data-format",{format:e}),onClick:()=>W(e)}))}]}],[W,l,R,k]);return!M&&Q?f.createElement(Re,null,l("common:error")):f.createElement(Se,null,f.createElement(ze,{ref:j,title:o,options:ae,data:M,loading:Z,zoom:!0}),f.createElement(De,{items:re}))};export default Ee;
